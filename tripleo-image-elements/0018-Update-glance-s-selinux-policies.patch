From 3502339ddf7e2ddaa3dd13bc8f0cb83a680f7677 Mon Sep 17 00:00:00 2001
From: Richard Su <rwsu@redhat.com>
Date: Tue, 25 Mar 2014 12:04:53 -0700
Subject: [PATCH 4/5] Update glance's selinux policies

Also moved directory creation from post-configure.d
to configure.d

Change-Id: Ic7fc2a3b053efeb4ccfc3d97b94a5a3d8d88a1bd
---
 elements/glance/os-refresh-config/configure.d/10-glance-state  |  4 ++++
 .../glance/os-refresh-config/configure.d/20-glance-selinux     | 10 ++++++++++
 elements/glance/os-refresh-config/post-configure.d/75-glance   |  4 ----
 3 files changed, 14 insertions(+), 4 deletions(-)
 create mode 100755 elements/glance/os-refresh-config/configure.d/10-glance-state
 create mode 100755 elements/glance/os-refresh-config/configure.d/20-glance-selinux

diff --git a/elements/glance/os-refresh-config/configure.d/10-glance-state b/elements/glance/os-refresh-config/configure.d/10-glance-state
new file mode 100755
index 0000000..dce4152
--- /dev/null
+++ b/elements/glance/os-refresh-config/configure.d/10-glance-state
@@ -0,0 +1,4 @@
+#!/bin/bash
+[ -d /mnt/state/var/lib/glance ] || install -d -D -m 0770 -o glance -g glance /mnt/state/var/lib/glance
+[ -d /mnt/state/var/lib/glance/images ] || install -d -D -m 0770 -o glance -g glance /mnt/state/var/lib/glance/images
+[ -d /mnt/state/var/log/glance ] || install -d -D -m 0755 -o glance -g glance /mnt/state/var/log/glance
diff --git a/elements/glance/os-refresh-config/configure.d/20-glance-selinux b/elements/glance/os-refresh-config/configure.d/20-glance-selinux
new file mode 100755
index 0000000..d093549
--- /dev/null
+++ b/elements/glance/os-refresh-config/configure.d/20-glance-selinux
@@ -0,0 +1,10 @@
+#!/bin/bash
+set -eu
+
+[ -x /usr/sbin/semanage ] || exit 0
+
+semanage fcontext -a -t glance_var_lib_t "/mnt/state/var/lib/glance(/.*)?"
+restorecon -Rv /mnt/state/var/lib/glance
+
+semanage fcontext -a -t glance_log_t "/mnt/state/var/log/glance(/.*)?"
+restorecon -Rv /mnt/state/var/log/glance
diff --git a/elements/glance/os-refresh-config/post-configure.d/75-glance b/elements/glance/os-refresh-config/post-configure.d/75-glance
index 9827fa0..295ab06 100755
--- a/elements/glance/os-refresh-config/post-configure.d/75-glance
+++ b/elements/glance/os-refresh-config/post-configure.d/75-glance
@@ -1,10 +1,6 @@
 #!/bin/bash
 set -eu
 
-[ -d /mnt/state/var/lib/glance ] || install -d -D -m 0770 -o glance -g glance /mnt/state/var/lib/glance
-[ -d /mnt/state/var/lib/glance/images ] || install -d -D -m 0770 -o glance -g glance /mnt/state/var/lib/glance/images
-[ -d /mnt/state/var/log/glance ] || install -d -D -m 0755 -o glance -g glance /mnt/state/var/log/glance
-
 glance-manage db_sync
 
 os-svc-enable -n glance-api
-- 
1.9.0

